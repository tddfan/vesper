<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vesper v3.0 ‚Äî Quant Intelligence</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { mono: ['"JetBrains Mono"', 'ui-monospace', 'monospace'] },
        },
      },
    }
  </script>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <!-- Inter + JetBrains Mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, sans-serif; }
    .glass { background: #0f172a; border: 1px solid #1e293b; border-radius: 1rem; }
    .glass:hover { border-color: #334155; }
    .tnum { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    .vesper-glow { box-shadow: 0 0 60px rgba(99, 102, 241, 0.12); }
    .sentiment-bar { height: 8px; border-radius: 9999px; overflow: hidden; display: flex; }
    .tooltip-trigger { cursor: pointer; color: #6366f1; transition: color 0.2s; }
    .tooltip-trigger:hover { color: #818cf8; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 9999px; }
    
    /* Simple Modal Tooltip */
    #tooltip-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.8); backdrop-blur: 4px; }
    .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 450px; background: #0f172a; border: 1px solid #312e81; padding: 2.5rem; border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen antialiased">

  <!-- Tooltip Modal -->
  <div id="tooltip-modal" onclick="closeTooltip()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="flex justify-between items-start mb-4">
        <p id="tooltip-title" class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.3em]"></p>
        <button onclick="closeTooltip()" class="text-slate-500 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <p id="tooltip-body" class="text-sm text-slate-300 leading-relaxed font-medium"></p>
      <div class="mt-8 pt-4 border-t border-slate-800 flex justify-between items-center">
        <p class="text-[10px] text-slate-600 font-bold uppercase tracking-widest">Quant Verification Suite v3.0</p>
        <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-20 border-b border-slate-800/70 backdrop-blur bg-slate-950/80 px-6 py-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3 group cursor-pointer" onclick="location.reload()">
        <!-- Refined Logo -->
        <div class="relative w-10 h-10 flex items-center justify-center">
          <div class="absolute inset-0 bg-indigo-500/20 blur-2xl group-hover:bg-indigo-500/40 transition-all rounded-full"></div>
          <svg class="relative w-8 h-8 text-indigo-500 filter drop-shadow-[0_0_8px_rgba(99,102,241,0.8)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
          </svg>
        </div>
        <div>
          <span class="text-xl font-black tracking-tighter block leading-none bg-clip-text text-transparent bg-gradient-to-r from-white via-indigo-200 to-slate-400">VESPER v3.0</span>
          <span class="text-[9px] text-slate-500 font-black uppercase tracking-[0.3em] block mt-0.5">Quant Intelligence</span>
        </div>
      </div>
      <div id="health-dot" class="flex items-center gap-3 text-[10px] text-slate-600 font-black tracking-widest uppercase">
        <span class="w-2 h-2 rounded-full bg-slate-700 inline-block shadow-[0_0_5px_rgba(51,65,85,0.5)]" id="health-indicator"></span>
        <span id="health-label">System Init...</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-10">

    <section id="builder-section" class="mb-10">
      <h1 class="text-3xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-500 uppercase tracking-tight">Portfolio Forge</h1>
      <p class="text-slate-500 text-sm mb-6">Real-time asset allocation with v3.0 risk contribution math.</p>
      <div class="glass p-6 sm:p-8 vesper-glow">
        <div id="ticker-rows" class="space-y-3 mb-5"></div>

        <!-- Risk Profile Selector -->
        <div class="mb-6 p-4 bg-slate-900/50 rounded-xl border border-slate-800">
          <div class="flex items-center justify-between mb-3">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Mandate Target</p>
            <span class="text-[10px] text-slate-600 font-medium italic">Configures rebalancing logic</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <label class="cursor-pointer">
              <input type="radio" name="risk-level" value="Conservative" class="hidden peer">
              <div class="py-2.5 text-center rounded-lg border border-slate-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/10 peer-checked:text-emerald-400 hover:bg-slate-800 transition-all">
                <div class="text-sm mb-0.5">üõ°Ô∏è</div>
                <div class="text-[9px] font-black uppercase tracking-tighter">Conservative</div>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="risk-level" value="Balanced" checked class="hidden peer">
              <div class="py-2.5 text-center rounded-lg border border-slate-700 peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 peer-checked:text-indigo-400 hover:bg-slate-800 transition-all">
                <div class="text-sm mb-0.5">‚öñÔ∏è</div>
                <div class="text-[9px] font-black uppercase tracking-tighter">Balanced</div>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="risk-level" value="Aggressive" class="hidden peer">
              <div class="py-2.5 text-center rounded-lg border border-slate-700 peer-checked:border-orange-500 peer-checked:bg-orange-500/10 peer-checked:text-orange-400 hover:bg-slate-800 transition-all">
                <div class="text-sm mb-0.5">üöÄ</div>
                <div class="text-[9px] font-black uppercase tracking-tighter">Aggressive</div>
              </div>
            </label>
          </div>
        </div>

        <button onclick="addRow()" class="w-full py-2.5 rounded-xl border border-dashed border-slate-700 text-slate-500 hover:text-slate-300 hover:border-slate-500 text-sm font-semibold transition-all flex items-center justify-center gap-2 mb-5">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
          Add Position
        </button>
        <button onclick="analyzePortfolio()" id="analyse-btn" class="w-full py-4 rounded-2xl bg-gradient-to-r from-indigo-600 to-violet-600 font-black text-lg hover:from-indigo-500 hover:to-violet-500 transition-all shadow-lg shadow-indigo-900/40 flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          EXECUTE QUANT ENGINE
        </button>
      </div>
    </section>

    <div id="loading-state" class="hidden text-center py-24">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full border-4 border-slate-800 border-t-indigo-500 spinner mb-6"></div>
      <h3 class="text-xl font-bold mb-2">Simulating Scenarios...</h3>
      <p class="text-slate-400 text-sm font-mono uppercase tracking-widest text-[10px]">Risk Contribution Math ‚Ä¢ Sentiment Trend Engine ‚Ä¢ Guardrail Audit</p>
    </div>

    <section id="results-section" class="hidden space-y-6">
      <div id="summary-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div>
      
      <!-- Risk Profile -->
      <div class="glass p-6 border-l-4 border-indigo-500">
        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">Risk Profile Analysis <span class="tooltip-trigger" onclick="showTooltip('Efficiency Identity', 'Risk-adjusted metrics relative to your chosen profile mandate.')">‚ìò</span></p>
        <div id="risk-profile-content" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
      </div>

      <!-- Intel Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div class="glass p-6 border-t-2 border-red-500/50">
          <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Stress Simulation</p>
          <div id="scenario-content" class="space-y-4"></div>
        </div>
        <div class="glass p-6 border-t-2 border-emerald-500/50">
          <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Smart Rebalancing</p>
          <div id="rebalance-content" class="space-y-4"></div>
        </div>
        <div class="glass p-6 border-t-2 border-amber-500/50">
          <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Factor & Contribution</p>
          <div id="factor-content" class="space-y-4"></div>
        </div>
        <div class="glass p-6 border-t-2 border-indigo-500/50">
          <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Currency Strategy</p>
          <div id="currency-panel" class="space-y-3"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass p-6">
          <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Allocation Spectrum</p>
          <div class="flex items-center justify-center" style="height:260px;"><canvas id="allocationChart"></canvas></div>
        </div>
        <div class="glass p-6 flex flex-col">
          <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Advisory Optimizer</p>
          <div id="risk-optimizer" class="space-y-3 flex-1 overflow-y-auto pr-2" style="max-height:320px;"></div>
        </div>
      </div>

      <div class="glass p-6">
        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Historical Growth Velocity</p>
        <div style="height:340px;" class="mt-4"><canvas id="historyChart"></canvas></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass p-6">
          <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Vesper 5-Point Intelligence</p>
          <div id="market-outlook" class="space-y-4"></div>
        </div>
        <div class="glass p-6 flex flex-col">
          <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">10-Year Probability Corridor</p>
          <div class="flex-1" style="min-height:240px;"><canvas id="futureChart"></canvas></div>
          <div id="future-details" class="mt-4 p-4 bg-indigo-950/20 border-l-2 border-indigo-500 rounded text-[10px] text-slate-400 leading-relaxed"></div>
        </div>
      </div>

      <div class="glass p-6 flex flex-col">
        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Sentiment Trend Aggregator</p>
        <div id="sentiment-summary-panel" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </div>

      <div>
        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Asset Detail Suite</p>
        <div id="asset-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </div>
    </section>
  </main>

  <footer class="mt-20 border-t border-slate-900 py-10 text-center text-slate-700 text-xs font-mono tracking-widest uppercase">
    Vesper Intelligence Engine ‚Ä¢ Senior Quant Suite v3.0
  </footer>

  <script>
    'use strict'
    
    window.onerror = function(msg, url, line, col, error) {
      console.error("GLOBAL ERROR:", msg, "\nAt:", url, ":", line, ":", col, "\nStack:", error?.stack);
      return false;
    };
    window.onunhandledrejection = function(event) {
      console.error("UNHANDLED REJECTION:", event.reason);
    };

    const API_URL = '/api/analyze'
    let rowIndex = 0, allocChart = null, historyChart = null, futureChart = null
    const PALETTE = ['#6366f1','#8b5cf6','#ec4899','#f59e0b','#10b981','#3b82f6','#f97316','#14b8a6','#ef4444','#a855f7','#0ea5e9','#22c55e']

    function addRow(t = '', q = '') {
      try {
        rowIndex++
        const id = `row-${rowIndex}`, div = document.createElement('div')
        div.id = id; div.className = 'grid grid-cols-[1fr_110px_44px] gap-3 items-center'
        div.innerHTML = `<input type="text" value="${t}" placeholder="Ticker" class="ticker-input bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 text-sm font-bold uppercase focus:border-indigo-500 focus:outline-none transition-colors shadow-inner"><input type="number" value="${q}" placeholder="Qty" class="qty-input bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 text-sm font-bold tnum focus:border-indigo-500 focus:outline-none transition-colors shadow-inner"><button onclick="removeRow('${id}')" class="w-11 h-11 rounded-xl border border-slate-800 hover:border-red-600 hover:text-red-400 text-slate-700 transition-all flex items-center justify-center group"><svg class="group-hover:rotate-90 transition-transform" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg></button>`
        const container = document.getElementById('ticker-rows');
        if (container) container.appendChild(div);
      } catch (e) { console.error("addRow error:", e); }
    }
    
    function removeRow(id) { 
      const row = document.getElementById(id);
      if (row && document.querySelectorAll('#ticker-rows > div').length > 1) row.remove();
    }
    
    function pollHealth() {
      fetch('/health').then(r => r.json()).then(d => {
        const dot = document.getElementById('health-indicator'), lbl = document.getElementById('health-label');
        if (!dot || !lbl) return;
        if (d.status === 'ok') {
          dot.className = 'w-2 h-2 rounded-full bg-green-500 inline-block shadow-[0_0_8px_#22c55e]';
          lbl.textContent = 'NEURAL ENGINE READY';
          lbl.className = 'text-green-600 font-black tracking-widest';
        } else {
          setTimeout(pollHealth, 3000);
        }
      }).catch(e => { console.error("health poll error:", e); setTimeout(pollHealth, 5000); });
    }

    async function analyzePortfolio() {
      const holdings = {}; document.querySelectorAll('#ticker-rows > div').forEach(row => {
        const t = row.querySelector('.ticker-input').value.trim().toUpperCase(), q = parseFloat(row.querySelector('.qty-input').value)
        if (t && q > 0) holdings[t] = (holdings[t] || 0) + q
      })
      if (Object.keys(holdings).length === 0) return
      const riskLevel = document.querySelector('input[name="risk-level"]:checked').value;
      document.getElementById('loading-state').classList.remove('hidden'); document.getElementById('results-section').classList.add('hidden')
      try {
        const res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ holdings, risk_level: riskLevel }) })
        if (!res.ok) throw new Error((await res.json()).detail || 'Engine Failed')
        renderResults(await res.json(), riskLevel)
      } catch (e) { console.error("analyze error:", e); alert(e.message); } finally { document.getElementById('loading-state').classList.add('hidden') }
    }

    function fmt(v, t = 'plain') {
      if (v === 'N/A' || v == null) return 'N/A'
      const n = parseFloat(v); if (isNaN(n)) return v
      if (t === 'currency') return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
      if (t === 'pct') return (n * 100).toFixed(2) + '%'
      return n.toLocaleString()
    }
    function retClr(v) { const n = parseFloat(v); return isNaN(n) ? '' : n >= 0 ? 'text-green-400' : 'text-red-400' }
    function sentimentBadge(l) { 
      if (l === 'positive') return { text: 'Bullish', cls: 'text-green-400 bg-green-950 border-green-500/30' };
      if (l === 'negative') return { text: 'Bearish', cls: 'text-red-400 bg-red-950 border-red-500/30' };
      return { text: 'Neutral', cls: 'text-slate-400 bg-slate-900 border-slate-700' };
    }

    function renderResults(data, riskLevel) {
      try {
        const { portfolio: p, assets: a, risk: r, market_outlook: mo, advanced_intel: ai, recommendations: recs, currency_analysis: ca } = data
        const ksId = 'kill-switch-banner';
        let ks = document.getElementById(ksId);
        if (ai.kill_switch) {
          if (!ks) { ks = document.createElement('div'); ks.id = ksId; document.getElementById('results-section').prepend(ks); }
          ks.className = 'bg-red-600 text-white p-4 rounded-xl mb-6 flex items-center gap-4 animate-pulse border-2 border-red-400 shadow-[0_0_20px_rgba(220,38,38,0.5)]';
          ks.innerHTML = `<div class="text-2xl">‚ö†Ô∏è</div><div><p class="font-black uppercase tracking-tighter text-sm">System Guardrail Breach</p><p class="text-xs font-bold text-red-100">${ai.kill_switch}</p></div>`;
        } else if (ks) { ks.remove(); }
        renderSummaryCards(p, r); renderRiskProfile(p, riskLevel, ai); renderAllocationChart(a); renderHistoryChart(r.history || {}, a); renderMarketOutlook(mo || {}); renderFutureValue(r.future_value || {}, p.total_value); renderAdvancedIntel(ai); renderRiskOptimizer(recs || []); renderCurrencyAnalysis(ca || {}); renderSentimentSummary(a); renderAssetCards(a, data.events || {}, r.asset_risk || {}, r.history || {}, ai);
        document.getElementById('results-section').classList.remove('hidden'); document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' })
      } catch (e) { console.error("renderResults error:", e); }
    }

    function renderSummaryCards(p, r) {
      const bc = retClr(p.portfolio_beta); document.getElementById('summary-grid').innerHTML = [
        { i: 'üíº', l: 'Net Value', v: fmt(p.total_value, 'currency'), s: p.asset_count + ' Holdings', t: 'Net Liquidity', d: 'Total dollar value of all equity positions.' },
        { i: 'üõ°Ô∏è', l: 'VaR 95%', v: fmt(p.var_95_daily, 'pct'), s: '1-Day Risk', t: 'Value at Risk (VaR)', d: 'Maximum expected loss over 24h at 95% confidence.' },
        { i: 'üìä', l: 'Beta Sensitivity', v: `<span class="${bc}">${p.portfolio_beta}</span>`, s: 'vs S&P 500', t: 'Beta Sensitivity', d: 'Portfolio sensitivity to broad market moves.' },
        { i: 'üìà', l: '10Y Median', v: fmt(p.rolling_10y_median, 'pct'), s: 'Expected CAGR', t: 'Expected CAGR', d: 'Historical typical annualized returns.' }
      ].map(c => `<div class="glass p-5 border-t-2 border-indigo-500/20 hover:bg-slate-900/50 transition-colors"><div class="flex justify-between items-start"><div class="text-2xl mb-3">${c.i}</div><button onclick="showTooltip('${c.t}', '${c.d}')" class="text-[10px] text-slate-700 font-bold uppercase tracking-widest hover:text-indigo-400 transition-colors">‚ìò</button></div><div class="text-2xl font-black mb-0.5">${c.v}</div><div class="text-[10px] text-slate-600 font-bold uppercase mb-1">${c.s}</div><div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">${c.l}</div></div>`).join('')
    }

    function renderRiskProfile(p, level, ai) {
      const badgeCls = level === 'Conservative' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/50' : level === 'Aggressive' ? 'bg-orange-500/20 text-orange-400 border-orange-500/50' : 'bg-indigo-500/20 text-indigo-400 border-indigo-500/50';
      document.getElementById('risk-profile-content').innerHTML = `<div class="space-y-1"><p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest flex items-center gap-2">Target Profile <button onclick="showTooltip('Mandate', 'Your chosen mandate.')" class="hover:text-indigo-400">‚ìò</button></p><span class="px-3 py-1 rounded-full border text-xs font-black ${badgeCls}">${level}</span></div><div class="space-y-1"><p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest flex items-center gap-2">Efficiency (Sharpe) <button onclick="showTooltip('Sharpe Ratio', 'Returns per unit of volatility.')" class="hover:text-indigo-400">‚ìò</button></p><p class="text-xl font-black text-slate-200">${p.sharpe_ratio}</p></div><div class="space-y-1"><p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest flex items-center gap-2">Outlook Score <button onclick="showTooltip('Outlook Index', 'Score based on neural sentiment.')" class="hover:text-indigo-400">‚ìò</button></p><p class="text-xl font-black ${retClr(ai.outlook_score)}">${ai.outlook_score > 0 ? '+' : ''}${ai.outlook_score}</p></div>`;
    }

    function renderAdvancedIntel(ai) {
      // 1. Stress Simulation (v4.0 with FX Shock)
      document.getElementById('scenario-content').innerHTML = `
        <div class="bg-slate-900/50 p-3 rounded border border-slate-800 flex justify-between mb-2 hover:border-red-500/30 transition-colors">
          <span class="text-[10px] font-bold text-slate-400 uppercase">Nasdaq -10% Shock</span>
          <span class="text-xs font-black text-red-400">-$${fmt(Math.abs(ai.scenarios.nasdaq_10))}</span>
        </div>
        <div class="bg-slate-900/50 p-3 rounded border border-slate-800 flex justify-between mb-2 hover:border-amber-500/30 transition-colors">
          <span class="text-[10px] font-bold text-slate-400 uppercase">FX 5% Shock (Cable)</span>
          <span class="text-xs font-black text-amber-400">-$${fmt(ai.scenarios.fx_5pct_shock)}</span>
        </div>`;

      // 2. Smart Rebalancing (v4.0 with Alpha Projection)
      const driftColor = Math.abs(ai.rebalancing.drift) > 0.05 ? 'text-amber-400' : 'text-emerald-400';
      document.getElementById('rebalance-content').innerHTML = `
        <div class="grid grid-cols-2 gap-2 mb-3">
          <div class="bg-slate-900/50 p-2 rounded border border-slate-800">
            <p class="text-[8px] text-slate-500 uppercase font-bold">Proj Sharpe</p>
            <p class="text-xs font-black text-emerald-400">‚Üí ${ai.rebalancing.projected_sharpe}</p>
          </div>
          <div class="bg-slate-900/50 p-2 rounded border border-slate-800">
            <p class="text-[8px] text-slate-500 uppercase font-bold">Proj Beta</p>
            <p class="text-xs font-black text-indigo-400">‚Üí ${ai.rebalancing.projected_beta}</p>
          </div>
        </div>
        <div class="p-3 bg-indigo-500/10 border border-indigo-500/30 rounded-lg">
          <p class="text-[10px] text-slate-300 leading-tight font-medium">${ai.rebalancing.trade || 'Portfolio aligned.'}</p>
        </div>`;
      
      // 3. Diversification Alpha (v4.0 Diversification Ratio)
      const dr = ai.attribution.div_ratio || 1.0;
      const drCls = dr < 1.1 ? 'text-red-400 animate-pulse' : 'text-emerald-400';
      const drLabel = dr < 1.1 ? 'CONCENTRATED' : 'DIVERSIFIED';
      document.getElementById('factor-content').innerHTML = `
        <div class="flex justify-between mb-2">
          <span class="text-[10px] font-bold text-slate-400 uppercase">Div. Ratio (DR)</span>
          <span class="text-xs font-black ${drCls}">${dr}</span>
        </div>
        <div class="flex justify-between mb-2">
          <span class="text-[10px] font-bold text-slate-400 uppercase">Factor Breadth</span>
          <span class="text-xs font-black text-indigo-400 uppercase tracking-tighter">${drLabel}</span>
        </div>
        <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden mt-4">
          <div class="h-full bg-indigo-500 shadow-[0_0_8px_#6366f1]" style="width: ${Math.min(100, dr * 50)}%"></div>
        </div>
        <p class="text-[8px] text-slate-600 text-right mt-1 font-bold uppercase tracking-widest">Target DR: > 1.20</p>`;
    }

    function renderCurrencyAnalysis(ca) {
      if (!ca || !ca.exposure) return;
      const ex = Object.entries(ca.exposure).sort((a,b) => b[1]-a[1]);
      const flags = { USD:'üá∫üá∏', EUR:'üá™üá∫', GBP:'üá¨üáß', JPY:'üáØüáµ', CAD:'üá®üá¶', AUD:'üá¶üá∫', CNY:'üá®üá≥', HKD:'üá≠üá∞' };
      document.getElementById('currency-panel').innerHTML = ex.map(([c, w]) => `<div class="space-y-1"><div class="flex justify-between items-center"><span class="text-[10px] font-bold text-slate-300">${flags[c]||'üåê'} ${c}</span><span class="text-[10px] font-black text-indigo-400">${(w*100).toFixed(1)}%</span></div><div class="h-1 bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width: ${w*100}%"></div></div></div>`).join('');
    }

    function renderAllocationChart(assets) {
      const labels = Object.keys(assets), values = labels.map(k => assets[k].value);
      if (allocChart) allocChart.destroy();
      allocChart = new Chart(document.getElementById('allocationChart'), { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: PALETTE, borderColor: '#020617', borderWidth: 3 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { weight: 'bold', size: 11 } } } } } });
    }

    function renderSentimentSummary(assets) {
      const panel = document.getElementById('sentiment-summary-panel');
      if (!panel) return;
      panel.innerHTML = Object.entries(assets).map(([tk, a]) => {
        const s = a.sentiment || {}, b = Math.round((s.bullish || 0)*100), r = Math.round((s.bearish || 0)*100), badge = sentimentBadge(s.label);
        const delta = s.sentiment_delta || 0, deltaCls = delta < 0 ? 'text-red-400' : 'text-emerald-400';
        const exhaustion = s.exhaustion_alert ? '<span class="text-[7px] bg-red-600 text-white px-1 rounded animate-bounce">EXHAUSTION</span>' : '';
        return `<div class="p-4 bg-slate-900/30 rounded-xl border border-slate-800 hover:bg-slate-900/50 transition-all"><div class="flex items-center justify-between mb-2"><span class="font-black text-sm text-slate-200">${tk}</span><div class="flex items-center gap-2">${exhaustion}<span class="text-[9px] font-black px-2 py-0.5 rounded border ${badge.cls}">${badge.text}</span></div></div><div class="sentiment-bar mb-2"><div style="width:${b}%; background:#22c55e; box-shadow: 0 0 10px rgba(34,197,94,0.4)"></div><div style="width:${100-b-r}%; background:#334155;"></div><div style="width:${r}%; background:#ef4444; box-shadow: 0 0 10px rgba(239,68,68,0.4)"></div></div><div class="flex justify-between text-[8px] font-black uppercase tracking-tighter"><span>Bull ${b}%</span><span class="${deltaCls}">Delta: ${delta > 0 ? '+' : ''}${delta}</span><span>Bear ${r}%</span></div></div>`;
      }).join('');
    }

    function renderHistoryChart(h, a) {
      if (historyChart) historyChart.destroy();
      const pf = h['__portfolio__']; if (!pf) return;
      const ds = Object.keys(a).map((tk, i) => ({ label: tk, data: h[tk]?.values, borderColor: PALETTE[i%PALETTE.length], borderWidth: 1.5, pointRadius: 0, tension: 0.3, borderDash: [2, 2], hidden: true }));
      ds.push({ label: 'CORE', data: pf.values, borderColor: '#fff', borderWidth: 3, pointRadius: 0, tension: 0.3 });
      historyChart = new Chart(document.getElementById('historyChart'), { type: 'line', data: { labels: pf.dates, datasets: ds }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#64748b', font: { size: 9, weight: 'bold' } } } }, scales: { x: { ticks: { color: '#334155', font: { size: 9 }, maxTicksLimit: 8 } }, y: { ticks: { color: '#334155', font: { size: 9 } }, grid: { color: '#1e293b' } } } } });
    }

    function renderMarketOutlook(mo) {
      const e = (mo.points || []).map(x => `<div class="p-4 bg-slate-900/50 rounded-xl border border-slate-800 transition-all group hover:border-indigo-500/30"> <div class="flex items-center gap-3 mb-2"> <div class="text-xl group-hover:scale-110 transition-transform">${x.i}</div> <div><p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">${x.l}</p><p class="text-xs font-black text-indigo-400">${x.v}</p></div> </div> <p class="text-[10px] leading-relaxed text-slate-500 font-medium text-justify">${x.d}</p> </div>`).join('');
      document.getElementById('market-outlook').innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${e}</div><div class="mt-6 space-y-4"><div class="p-4 bg-indigo-950/20 border-l-4 border-indigo-500 rounded-r-xl relative"><p class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-2 flex items-center gap-2">Quant Intelligence</p><p class="text-sm text-slate-300 leading-relaxed">${mo.commentary}</p></div><div class="p-4 bg-violet-950/20 border-l-4 border-violet-500 rounded-r-xl"><p class="text-xs font-bold text-violet-400 uppercase tracking-widest mb-2">Strategic Outlook</p><p class="text-sm text-slate-300 leading-relaxed">${mo.future_outlook}</p></div></div>`;
    }

    function renderFutureValue(fv, tv) {
      if (futureChart) futureChart.destroy();
      const labels = Array.from({ length: 11 }, (_, i) => 'Y' + i), toVal = arr => arr.map(m => Math.round(m * tv));
      futureChart = new Chart(document.getElementById('futureChart'), { type: 'line', data: { labels, datasets: [{ label: 'P90', data: toVal(fv.p90), borderColor: '#22c55e', borderDash: [5, 5], pointRadius: 0 }, { label: 'Median', data: toVal(fv.p50), borderColor: '#6366f1', fill: true, backgroundColor: 'rgba(99,102,241,0.05)', borderWidth: 3 }, { label: 'P10', data: toVal(fv.p10), borderColor: '#ef4444', borderDash: [5, 5], pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } } } } });
      document.getElementById('future-details').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-indigo-500/5 p-4 rounded-xl border border-indigo-500/20"><p class="font-black text-indigo-400 uppercase tracking-tighter mb-2">Median</p><p class="text-lg font-black text-slate-200 mb-1">${fmt(fv.p50[10]*tv, 'currency')}</p></div><div class="bg-emerald-500/5 p-4 rounded-xl border border-emerald-500/20"><p class="font-black text-emerald-400 uppercase tracking-tighter mb-2">Bull</p><p class="text-lg font-black text-slate-200 mb-1">${fmt(fv.p90[10]*tv, 'currency')}</p></div><div class="bg-red-500/5 p-4 rounded-xl border border-red-500/20"><p class="font-black text-red-400 uppercase tracking-tighter mb-2">Stress</p><p class="text-lg font-black text-slate-200 mb-1">${fmt(fv.p10[10]*tv, 'currency')}</p></div></div>`;
    }

    function renderRiskOptimizer(recs) {
      document.getElementById('risk-optimizer').innerHTML = recs.map(r => `<div class="border rounded-xl p-5 border-indigo-900/40 bg-indigo-950/10 space-y-3"><div class="flex justify-between items-start gap-4"><div class="flex gap-3"><div class="text-xl">${r.icon}</div><div><p class="text-[11px] font-black text-slate-100 uppercase tracking-tight">${r.title}</p><p class="text-[10px] text-slate-400 font-medium">${r.detail}</p></div></div><span class="px-2 py-0.5 rounded text-[8px] font-black bg-indigo-500 text-white">${r.action || 'ADVISORY'}</span></div></div>`).join('') || '<p class="text-slate-700 text-xs italic">Alignment Verified.</p>';
    }

    function renderAssetCards(assets, events, ar, h, ai) {
      document.getElementById('asset-cards').innerHTML = Object.entries(assets).map(([tk, a], i) => {
        const c = PALETTE[i % PALETTE.length], b = sentimentBadge(a.sentiment?.label), safety = ai?.div_safety[tk] || 0, safetyColor = safety > 70 ? 'text-emerald-400' : safety > 40 ? 'text-amber-400' : 'text-red-400';
        const headlines = (a.sentiment?.headlines || []).slice(0,3).map(h => `<li class="text-[9px] text-slate-500 mb-1 line-clamp-1">‚Ä¢ ${typeof h === 'object' ? h.title : h}</li>`).join('') || '<li class="text-[9px] text-slate-700 italic">No signals.</li>';
        return `<div class="glass p-5 border-t-2" style="border-top-color: ${c}"> <div class="flex justify-between mb-4"> <div><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-black px-2 py-0.5 rounded" style="background:${c}22;color:${c}">${tk}</span><span class="text-[9px] font-black px-2 py-0.5 rounded border ${b.cls}">${b.text}</span></div><div class="font-bold text-sm text-slate-200 line-clamp-1">${a.name}</div></div> <div class="text-right"><div class="text-lg font-black tnum">${fmt(a.price, 'currency')}</div><p class="text-[8px] font-black ${safetyColor} uppercase">Safety: ${safety}</p></div> </div> <div class="grid grid-cols-2 gap-2 mb-4"> <div class="bg-slate-900/50 p-2 rounded border border-slate-800"><p class="text-slate-600 text-[9px] font-black uppercase">Risk Contrib</p><p class="text-xs font-black">${a.risk_contribution_pct}%</p></div> <div class="bg-slate-900/50 p-2 rounded border border-slate-800"><p class="text-slate-600 text-[9px] font-black uppercase">Inst. Flow</p><p class="text-xs font-black text-indigo-400">${a.institutional_flow_score}</p></div> </div> <div class="border-t border-slate-800/50 pt-3"><p class="text-[9px] font-black text-slate-600 uppercase mb-2">Neural Signals</p><ul class="list-none m-0 p-0">${headlines}</ul></div> </div>`;
      }).join('');
    }

    function showTooltip(title, body) {
      document.getElementById('tooltip-title').textContent = title;
      document.getElementById('tooltip-body').textContent = body;
      document.getElementById('tooltip-modal').style.display = 'block';
    }
    function closeTooltip() { document.getElementById('tooltip-modal').style.display = 'none'; }

    window.addEventListener('DOMContentLoaded', () => { 
      try {
        [['AAPL', 10], ['MSFT', 5], ['VWRP.L', 3]].forEach(([t, q]) => addRow(t, q)); 
        pollHealth();
      } catch (e) { console.error("DOMContentLoaded error:", e); }
    });
  </script>
</body>
</html>
